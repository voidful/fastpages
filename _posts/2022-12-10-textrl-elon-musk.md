---
keywords: fastai
description: How to control text generation through a sentiment classifier.
title: Controllable generation via RL to let Elon Musk speak ill of DOGE
toc: true 
badges: true
comments: true
categories: [jupyter]
nb_path: _notebooks/2022-12-10-textrl-elon-musk.ipynb
layout: notebook
---

<!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-12-10-textrl-elon-musk.ipynb
-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">pfrl</span><span class="nd">@git</span><span class="o">+</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">voidful</span><span class="o">/</span><span class="n">pfrl</span><span class="o">.</span><span class="n">git</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">textrl</span><span class="o">==</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">6</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">from</span> <span class="nn">textrl</span> <span class="kn">import</span> <span class="n">TextRLEnv</span><span class="p">,</span><span class="n">TextRLActor</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">AutoModelForTokenClassification</span><span class="p">,</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">AutoModelWithLMHead</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pfrl</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Using a pre-trained model, it can generate elonmusk's style tweets.</strong></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;huggingtweets/elonmusk&quot;</span><span class="p">)</span>  
<span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelWithLMHead</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;huggingtweets/elonmusk&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>a sentiment classifier for rl reward</strong></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">sentiment</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="s1">&#39;sentiment-analysis&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;cardiffnlp/twitter-roberta-base-sentiment&quot;</span><span class="p">,</span><span class="n">tokenizer</span><span class="o">=</span><span class="s2">&quot;cardiffnlp/twitter-roberta-base-sentiment&quot;</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">return_all_scores</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/usr/local/lib/python3.8/dist-packages/transformers/pipelines/text_classification.py:104: UserWarning: `return_all_scores` is now deprecated,  if want a similar funcionality use `top_k=None` instead of `return_all_scores=True` or `top_k=1` instead of `return_all_scores=False`.
  warnings.warn(
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">transformers_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;transformers&#39;</span><span class="p">)</span>
<span class="n">transformers_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">sentiment</span><span class="p">(</span><span class="s2">&quot;dogecoin is bad&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[[{&#39;label&#39;: &#39;LABEL_0&#39;, &#39;score&#39;: 0.9338533878326416},
  {&#39;label&#39;: &#39;LABEL_1&#39;, &#39;score&#39;: 0.06011885032057762},
  {&#39;label&#39;: &#39;LABEL_2&#39;, &#39;score&#39;: 0.0060277231968939304}]]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">sentiment</span><span class="p">(</span><span class="s2">&quot;dogecoin is bad&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.9338533878326416</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>set our text generation reward, inverse perplexity + sentiment classifier.</p>
<ul>
<li>inverse perplexity make sure the generated sentence probability will be high.</li>
<li>sentiment classifier can make the generate more negative.</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">MyRLEnv</span><span class="p">(</span><span class="n">TextRLEnv</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_item</span><span class="p">,</span> <span class="n">predicted_list</span><span class="p">,</span> <span class="n">finish</span><span class="p">):</span> <span class="c1"># predicted will be the list of predicted token</span>
      <span class="n">reward</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="n">finish</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">predicted_list</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_max_length</span><span class="p">:</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">predicted_list</span><span class="p">):</span>
          <span class="n">predicted_text</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">convert_tokens_to_string</span><span class="p">(</span><span class="n">predicted_list</span><span class="p">)</span>
          <span class="c1"># sentiment classifier</span>
          <span class="n">reward</span> <span class="o">+=</span> <span class="n">sentiment</span><span class="p">(</span><span class="n">input_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">predicted_text</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span>
      <span class="k">return</span> <span class="n">reward</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>fit one example</strong></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">observaton_list</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;i think dogecoin is&#39;</span><span class="p">]]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">MyRLEnv</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">observation_input</span><span class="o">=</span><span class="n">observaton_list</span><span class="p">)</span>
<span class="n">actor</span> <span class="o">=</span> <span class="n">TextRLActor</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">tokenizer</span><span class="p">)</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="n">agent_ppo</span><span class="p">(</span><span class="n">update_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">minibatch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">actor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">observaton_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39; a good idea&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">pfrl</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">train_agent_with_evaluation</span><span class="p">(</span>
    <span class="n">agent</span><span class="p">,</span>
    <span class="n">env</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">eval_n_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">eval_n_episodes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>       
    <span class="n">train_max_episode_len</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>  
    <span class="n">eval_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;elon_musk_dogecoin&#39;</span><span class="p">,</span> 
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/usr/local/lib/python3.8/dist-packages/textrl/actor.py:69: UserWarning: The use of `x.T` on tensors of dimension other than 2 to reverse their shape is deprecated and it will throw an error in a future release. Consider `x.mT` to transpose batches of matrices or `x.permute(*torch.arange(x.ndim - 1, -1, -1))` to reverse the dimensions of a tensor. (Triggered internally at ../aten/src/ATen/native/TensorShape.cpp:3277.)
  (prob_ratio.T * advs).T,
/usr/local/lib/python3.8/dist-packages/transformers/pipelines/base.py:1043: UserWarning: You seem to be using the pipelines sequentially on GPU. In order to maximize efficiency please use a dataset
  warnings.warn(
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(&lt;textrl.actor.TextPPO at 0x7f902414b6a0&gt;,
 [{&#39;average_value&#39;: 2.0006444,
   &#39;average_entropy&#39;: 0.17440723,
   &#39;average_value_loss&#39;: 1.3542563378810883,
   &#39;average_policy_loss&#39;: -0.04205846681725234,
   &#39;n_updates&#39;: 10,
   &#39;explained_variance&#39;: -2.7000492592458043,
   &#39;eval_score&#39;: 0.001555838156491518},
  {&#39;average_value&#39;: 1.2077988,
   &#39;average_entropy&#39;: 0.10219431,
   &#39;average_value_loss&#39;: 0.8049726754426956,
   &#39;average_policy_loss&#39;: -0.043247044883901256,
   &#39;n_updates&#39;: 20,
   &#39;explained_variance&#39;: nan,
   &#39;eval_score&#39;: 0.008166163228452206},
  {&#39;average_value&#39;: 0.68971634,
   &#39;average_entropy&#39;: 0.08226016,
   &#39;average_value_loss&#39;: 0.583228854338328,
   &#39;average_policy_loss&#39;: -0.03243164799874639,
   &#39;n_updates&#39;: 30,
   &#39;explained_variance&#39;: nan,
   &#39;eval_score&#39;: 0.009085850790143013},
  {&#39;average_value&#39;: 0.49251693,
   &#39;average_entropy&#39;: 0.07101057,
   &#39;average_value_loss&#39;: 0.44462784337811173,
   &#39;average_policy_loss&#39;: -0.03321644520212423,
   &#39;n_updates&#39;: 40,
   &#39;explained_variance&#39;: -112.08653704970607,
   &#39;eval_score&#39;: 0.9138848781585693},
  {&#39;average_value&#39;: 0.44328108,
   &#39;average_entropy&#39;: 0.058479678,
   &#39;average_value_loss&#39;: 0.40179401244968177,
   &#39;average_policy_loss&#39;: -0.030547107956139286,
   &#39;n_updates&#39;: 50,
   &#39;explained_variance&#39;: -0.042075806250177594,
   &#39;eval_score&#39;: 0.9138848781585693},
  {&#39;average_value&#39;: 0.4795684,
   &#39;average_entropy&#39;: 0.04970775,
   &#39;average_value_loss&#39;: 0.3383651294396259,
   &#39;average_policy_loss&#39;: -0.025455901640428043,
   &#39;n_updates&#39;: 60,
   &#39;explained_variance&#39;: nan,
   &#39;eval_score&#39;: 0.9138848781585693},
  {&#39;average_value&#39;: 0.5787231,
   &#39;average_entropy&#39;: 0.04142314,
   &#39;average_value_loss&#39;: 0.29252415439113977,
   &#39;average_policy_loss&#39;: -0.02181934324143011,
   &#39;n_updates&#39;: 70,
   &#39;explained_variance&#39;: -0.2262049999078275,
   &#39;eval_score&#39;: 0.9138848781585693},
  {&#39;average_value&#39;: 0.6124888,
   &#39;average_entropy&#39;: 0.036820583,
   &#39;average_value_loss&#39;: 0.2565400848223362,
   &#39;average_policy_loss&#39;: -0.01909192969484108,
   &#39;n_updates&#39;: 80,
   &#39;explained_variance&#39;: -4.575841818340245,
   &#39;eval_score&#39;: 0.9138848781585693},
  {&#39;average_value&#39;: 0.63870776,
   &#39;average_entropy&#39;: 0.033138536,
   &#39;average_value_loss&#39;: 0.22813357474113016,
   &#39;average_policy_loss&#39;: -0.016970614835801,
   &#39;n_updates&#39;: 90,
   &#39;explained_variance&#39;: nan,
   &#39;eval_score&#39;: 0.9138848781585693},
  {&#39;average_value&#39;: 0.6700342,
   &#39;average_entropy&#39;: 0.029824698,
   &#39;average_value_loss&#39;: 0.20538896852887775,
   &#39;average_policy_loss&#39;: -0.015273552626720602,
   &#39;n_updates&#39;: 100,
   &#39;explained_variance&#39;: -0.4705488598887635,
   &#39;eval_score&#39;: 0.9138848781585693}])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>loading the best result and predict.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">agent</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;./elon_musk_dogecoin/best&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">actor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">observaton_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39; a hoax&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

